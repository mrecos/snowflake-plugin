#!/usr/bin/env python3
"""Execute SQL query via Snowflake daemon."""
import sys
import os

# Add project root to path
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

from daemon.client import DaemonClient

# Get SQL from command line arguments
if len(sys.argv) < 2:
    print("Error: SQL query is required")
    print("Usage: sf-query <sql> [limit]")
    sys.exit(1)

sql = sys.argv[1]
limit = int(sys.argv[2]) if len(sys.argv) > 2 else 100

client = DaemonClient()
result = client.query(sql, limit=limit)

if not result.get('success'):
    print(f"❌ Query failed: {result.get('error', 'Unknown error')}")
    sys.exit(1)

# Display results
data = result.get('data', [])
columns = result.get('columns', [])
row_count = result.get('row_count', 0)
exec_time = result.get('execution_time', 0)

if row_count == 0:
    print("No results returned")
else:
    # Print as markdown table for better rendering in Claude Code
    if columns:
        # Header row
        print("| " + " | ".join(str(col) for col in columns) + " |")
        # Separator row
        print("|" + "|".join([" --- " for _ in columns]) + "|")

        # Data rows
        for row in data:
            print("| " + " | ".join(str(val) if val is not None else "NULL" for val in row) + " |")

print(f"\n✓ {row_count} row(s) in {exec_time:.3f}s")
